# âœ… Quy trÃ¬nh duyá»‡t yÃªu cáº§u 2 bÆ°á»›c

## ğŸ¯ Má»¥c Ä‘Ã­ch

Khi nhÃ¢n viÃªn táº¡o yÃªu cáº§u cho bá»™ pháº­n khÃ¡c, quy trÃ¬nh duyá»‡t cáº§n 2 bÆ°á»›c Ä‘á»ƒ Ä‘áº£m báº£o cháº¥t lÆ°á»£ng:
1. **Leader cá»§a bá»™ pháº­n Ä‘Æ°á»£c giao** duyá»‡t cÃ´ng viá»‡c Ä‘Ã£ hoÃ n thÃ nh
2. **NgÆ°á»i táº¡o yÃªu cáº§u** xÃ¡c nháº­n cuá»‘i cÃ¹ng ráº±ng yÃªu cáº§u Ä‘Ã£ Ä‘Ã¡p á»©ng Ä‘Ãºng nhu cáº§u

---

## ğŸ“‹ Quy trÃ¬nh

### VÃ­ dá»¥ thá»±c táº¿:
- NhÃ¢n viÃªn **Team IT** táº¡o yÃªu cáº§u: "Thiáº¿t káº¿ banner quáº£ng cÃ¡o"
- YÃªu cáº§u Ä‘Æ°á»£c giao cho **Team Marketing**
- Team Marketing hoÃ n thÃ nh cÃ´ng viá»‡c

### BÆ°á»›c 1: Leader duyá»‡t
**Leader Team Marketing** xem xÃ©t vÃ  duyá»‡t:
- âœ… Click nÃºt **"Duyá»‡t (Leader)"**
- âœ… Request chuyá»ƒn sang tráº¡ng thÃ¡i **`IN_REVIEW`** (mÃ u tÃ­m ğŸŸ£)
- âœ… NgÆ°á»i yÃªu cáº§u nháº­n notification

### BÆ°á»›c 2: NgÆ°á»i yÃªu cáº§u xÃ¡c nháº­n
**NhÃ¢n viÃªn Team IT** (ngÆ°á»i táº¡o yÃªu cáº§u) xem xÃ©t:
- âœ… Click nÃºt **"XÃ¡c nháº­n hoÃ n thÃ nh"** (mÃ u xanh dÆ°Æ¡ng)
- âœ… Request chuyá»ƒn sang tráº¡ng thÃ¡i **`DONE`** (mÃ u xanh lÃ¡ ğŸŸ¢)
- âœ… Leader Team Marketing nháº­n notification

---

## ğŸ”„ Flow Chart

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ NhÃ¢n viÃªn Team IT táº¡o yÃªu cáº§u cho Team Marketing            â”‚
â”‚ Status: OPEN                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Team Marketing hoÃ n thÃ nh cÃ´ng viá»‡c                         â”‚
â”‚ Táº¥t cáº£ tasks Ä‘Ã£ DONE                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BÆ¯á»šC 1: Leader Team Marketing duyá»‡t                         â”‚
â”‚ - Click "Duyá»‡t (Leader)"                                    â”‚
â”‚ - Status: OPEN â†’ IN_REVIEW                                  â”‚
â”‚ - Notify: NgÆ°á»i yÃªu cáº§u (IT)                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸŸ£ IN_REVIEW: "Chá» xÃ¡c nháº­n cuá»‘i"                           â”‚
â”‚                                                              â”‚
â”‚ Banner hiá»ƒn thá»‹:                                             â”‚
â”‚ "Leader Ä‘Ã£ duyá»‡t yÃªu cáº§u. Vui lÃ²ng xÃ¡c nháº­n hoÃ n thÃ nh"     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BÆ¯á»šC 2: NhÃ¢n viÃªn IT xÃ¡c nháº­n cuá»‘i cÃ¹ng                     â”‚
â”‚ - Click "XÃ¡c nháº­n hoÃ n thÃ nh"                               â”‚
â”‚ - Status: IN_REVIEW â†’ DONE                                  â”‚
â”‚ - Notify: Leader Marketing                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸŸ¢ DONE: YÃªu cáº§u hoÃ n thÃ nh hoÃ n toÃ n                       â”‚
â”‚ - completedAt: now()                                        â”‚
â”‚ - Audit log: REQUESTER_APPROVE_REQUEST                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”’ Ma tráº­n phÃ¢n quyá»n

### BÆ°á»›c 1: Leader duyá»‡t

| NgÆ°á»i dÃ¹ng | Request á»Ÿ OPEN/IN_PROGRESS | Request á»Ÿ IN_REVIEW | Ghi chÃº |
|------------|---------------------------|---------------------|---------|
| **Admin** | âœ… Duyá»‡t â†’ DONE | âœ… KhÃ´ng cáº§n bÆ°á»›c 2 | Duyá»‡t tháº³ng |
| **Leader (team Ä‘Æ°á»£c giao)** | âœ… Duyá»‡t â†’ IN_REVIEW | âŒ KhÃ´ng tháº¥y nÃºt | Chuyá»ƒn sang bÆ°á»›c 2 |
| **Leader (team khÃ¡c)** | âŒ KhÃ´ng tháº¥y nÃºt | âŒ KhÃ´ng tháº¥y nÃºt | KhÃ´ng cÃ³ quyá»n |
| **NgÆ°á»i yÃªu cáº§u** | âŒ KhÃ´ng tháº¥y nÃºt | - | Chá» leader duyá»‡t |

### BÆ°á»›c 2: NgÆ°á»i yÃªu cáº§u xÃ¡c nháº­n

| NgÆ°á»i dÃ¹ng | Request á»Ÿ IN_REVIEW | Ghi chÃº |
|------------|---------------------|---------|
| **Admin** | âœ… Duyá»‡t â†’ DONE | Duyá»‡t tháº³ng |
| **NgÆ°á»i yÃªu cáº§u** | âœ… XÃ¡c nháº­n â†’ DONE | XÃ¡c nháº­n cuá»‘i |
| **Leader** | âŒ KhÃ´ng tháº¥y nÃºt | ÄÃ£ duyá»‡t rá»“i |
| **NgÆ°á»i khÃ¡c** | âŒ KhÃ´ng tháº¥y nÃºt | KhÃ´ng cÃ³ quyá»n |

---

## ğŸ¨ UI/UX

### Status Badge

| Status | MÃ u | Label | Ã nghÄ©a |
|--------|-----|-------|---------|
| `OPEN` | ğŸ”µ Xanh dÆ°Æ¡ng | "Má»Ÿ" | Chá» xá»­ lÃ½ |
| `IN_PROGRESS` | ğŸŸ  Cam | "Äang xá»­ lÃ½" | Äang lÃ m |
| `IN_REVIEW` | ğŸŸ£ TÃ­m | "Chá» xÃ¡c nháº­n cuá»‘i" | Leader Ä‘Ã£ duyá»‡t, chá» requester |
| `DONE` | ğŸŸ¢ Xanh lÃ¡ | "HoÃ n thÃ nh" | HoÃ n thÃ nh hoÃ n toÃ n |

### NÃºt Action

**Leader tháº¥y (khi status â‰  IN_REVIEW, DONE, ARCHIVED):**
```tsx
<Button className="bg-green-600">
  <CheckCircle2 /> Duyá»‡t (Leader)
</Button>
```

**NgÆ°á»i yÃªu cáº§u tháº¥y (khi status = IN_REVIEW):**
```tsx
<Button className="bg-blue-600">
  <CheckCircle2 /> XÃ¡c nháº­n hoÃ n thÃ nh
</Button>
```

**Admin tháº¥y (má»i lÃºc):**
```tsx
<Button className="bg-green-600">
  <CheckCircle2 /> Duyá»‡t
</Button>
```

### Banner thÃ´ng bÃ¡o (IN_REVIEW)

Khi request á»Ÿ tráº¡ng thÃ¡i `IN_REVIEW`, hiá»ƒn thá»‹ banner mÃ u tÃ­m:

**Náº¿u ngÆ°á»i xem lÃ  ngÆ°á»i yÃªu cáº§u:**
```
âœ… YÃªu cáº§u Ä‘Ã£ Ä‘Æ°á»£c Leader duyá»‡t
Leader Ä‘Ã£ duyá»‡t yÃªu cáº§u nÃ y. Vui lÃ²ng xem xÃ©t vÃ  xÃ¡c nháº­n hoÃ n thÃ nh cuá»‘i cÃ¹ng.
```

**Náº¿u ngÆ°á»i xem lÃ  ngÆ°á»i khÃ¡c:**
```
âœ… YÃªu cáº§u Ä‘Ã£ Ä‘Æ°á»£c Leader duyá»‡t
Äang chá» ngÆ°á»i yÃªu cáº§u xÃ¡c nháº­n hoÃ n thÃ nh cuá»‘i cÃ¹ng.
```

---

## ğŸ“ Server Actions

### 1. `approveRequest(requestId)` - BÆ°á»›c 1: Leader duyá»‡t

**Logic:**
- âœ… RBAC: Chá»‰ Leader cá»§a team Ä‘Æ°á»£c giao hoáº·c Admin
- âœ… Kiá»ƒm tra: Táº¥t cáº£ tasks pháº£i DONE
- âœ… Admin: Duyá»‡t tháº³ng â†’ `DONE`
- âœ… Leader: Chuyá»ƒn â†’ `IN_REVIEW`
- âœ… Audit log: `LEADER_APPROVE_REQUEST`
- âœ… Notification: Gá»­i cho ngÆ°á»i yÃªu cáº§u

**Code:**
```typescript
// Leader approve
newStatus = "IN_REVIEW";

await prisma.notification.create({
  data: {
    userId: request.creator.id,
    type: "REVIEW_NEEDED",
    title: "YÃªu cáº§u Ä‘Ã£ Ä‘Æ°á»£c Leader duyá»‡t",
    message: "Leader Ä‘Ã£ duyá»‡t yÃªu cáº§u. Vui lÃ²ng xÃ¡c nháº­n hoÃ n thÃ nh cuá»‘i cÃ¹ng.",
  },
});
```

### 2. `requesterApproveRequest(requestId)` - BÆ°á»›c 2: NgÆ°á»i yÃªu cáº§u xÃ¡c nháº­n

**Logic:**
- âœ… RBAC: Chá»‰ ngÆ°á»i táº¡o yÃªu cáº§u
- âœ… Kiá»ƒm tra: Request pháº£i á»Ÿ tráº¡ng thÃ¡i `IN_REVIEW`
- âœ… Update: Status â†’ `DONE`, completedAt = now()
- âœ… Audit log: `REQUESTER_APPROVE_REQUEST`
- âœ… Notification: Gá»­i cho Leader

**Code:**
```typescript
await prisma.request.update({
  where: { id: requestId },
  data: {
    status: "DONE",
    completedAt: new Date(),
  },
});

await prisma.notification.create({
  data: {
    userId: request.team.leaderId,
    type: "COMPLETED",
    title: "YÃªu cáº§u Ä‘Ã£ hoÃ n thÃ nh",
    message: "NgÆ°á»i yÃªu cáº§u Ä‘Ã£ xÃ¡c nháº­n hoÃ n thÃ nh yÃªu cáº§u.",
  },
});
```

---

## ğŸ§ª Test Cases

### TC1: Quy trÃ¬nh hoÃ n chá»‰nh

**Äiá»u kiá»‡n:**
- User A (Staff Team IT) táº¡o request cho Team Marketing
- Team Marketing hoÃ n thÃ nh tasks
- User B (Leader Team Marketing)
- User A lÃ  ngÆ°á»i yÃªu cáº§u

**BÆ°á»›c test:**
1. User B login â†’ Má»Ÿ request detail
2. âœ… Tháº¥y nÃºt "Duyá»‡t (Leader)"
3. Click "Duyá»‡t (Leader)"
4. âœ… Request chuyá»ƒn sang `IN_REVIEW`
5. âœ… User A nháº­n notification
6. User A login â†’ Má»Ÿ request detail
7. âœ… Tháº¥y banner "Leader Ä‘Ã£ duyá»‡t yÃªu cáº§u"
8. âœ… Tháº¥y nÃºt "XÃ¡c nháº­n hoÃ n thÃ nh"
9. Click "XÃ¡c nháº­n hoÃ n thÃ nh"
10. âœ… Request chuyá»ƒn sang `DONE`
11. âœ… User B nháº­n notification

### TC2: Leader team khÃ¡c khÃ´ng tháº¥y nÃºt duyá»‡t

**Äiá»u kiá»‡n:**
- Request Ä‘Æ°á»£c giao cho Team Marketing
- User C lÃ  Leader Team IT

**Káº¿t quáº£:**
- âŒ User C KHÃ”NG tháº¥y nÃºt "Duyá»‡t (Leader)"
- âŒ Náº¿u call API, nháº­n error: "Báº¡n chá»‰ cÃ³ thá»ƒ duyá»‡t yÃªu cáº§u cá»§a team mÃ¬nh"

### TC3: NgÆ°á»i yÃªu cáº§u khÃ´ng thá»ƒ duyá»‡t khi status â‰  IN_REVIEW

**Äiá»u kiá»‡n:**
- Request á»Ÿ tráº¡ng thÃ¡i `OPEN`
- User A lÃ  ngÆ°á»i yÃªu cáº§u

**Káº¿t quáº£:**
- âŒ User A KHÃ”NG tháº¥y nÃºt "XÃ¡c nháº­n hoÃ n thÃ nh"
- âŒ Náº¿u call API, nháº­n error: "YÃªu cáº§u pháº£i Ä‘Æ°á»£c Leader duyá»‡t trÆ°á»›c"

### TC4: Admin duyá»‡t tháº³ng

**Äiá»u kiá»‡n:**
- Request á»Ÿ tráº¡ng thÃ¡i `OPEN`
- User X lÃ  Admin

**Káº¿t quáº£:**
- âœ… User X tháº¥y nÃºt "Duyá»‡t"
- âœ… Click â†’ Request chuyá»ƒn tháº³ng sang `DONE`
- âœ… KhÃ´ng cáº§n bÆ°á»›c 2

---

## ğŸ“Š Database Schema

### Request Model

```prisma
model Request {
  id          String        @id @default(uuid())
  status      RequestStatus @default(OPEN)
  completedAt DateTime?     // Set when status = DONE
  creatorId   String        // NgÆ°á»i táº¡o yÃªu cáº§u
  teamId      String?       // Team Ä‘Æ°á»£c giao
  // ... other fields
}

enum RequestStatus {
  OPEN
  IN_PROGRESS
  IN_REVIEW      // Leader Ä‘Ã£ duyá»‡t, chá» requester
  DONE           // HoÃ n thÃ nh hoÃ n toÃ n
  // ... other statuses
}
```

### Audit Log

```typescript
// Leader approve
{
  action: "LEADER_APPROVE_REQUEST",
  entity: "Request",
  entityId: requestId,
  newValue: { status: "IN_REVIEW" }
}

// Requester approve
{
  action: "REQUESTER_APPROVE_REQUEST",
  entity: "Request",
  entityId: requestId,
  newValue: { status: "DONE" }
}
```

---

## âœ¨ Lá»£i Ã­ch

1. **Kiá»ƒm soÃ¡t cháº¥t lÆ°á»£ng**: NgÆ°á»i yÃªu cáº§u xÃ¡c nháº­n cÃ´ng viá»‡c Ä‘Ã¡p á»©ng Ä‘Ãºng nhu cáº§u
2. **TrÃ¡ch nhiá»‡m rÃµ rÃ ng**: 
   - Leader chá»‹u trÃ¡ch nhiá»‡m vá» ká»¹ thuáº­t/chuyÃªn mÃ´n
   - Requester chá»‹u trÃ¡ch nhiá»‡m vá» yÃªu cáº§u nghiá»‡p vá»¥
3. **Giáº£m rá»§i ro**: KhÃ´ng xáº£y ra tÃ¬nh huá»‘ng "lÃ m xong nhÆ°ng khÃ´ng Ä‘Ãºng yÃªu cáº§u"
4. **Audit trail Ä‘áº§y Ä‘á»§**: Theo dÃµi ai duyá»‡t, khi nÃ o duyá»‡t
5. **UX tá»‘t**: Banner vÃ  nÃºt rÃµ rÃ ng, ngÆ°á»i dÃ¹ng biáº¿t cáº§n lÃ m gÃ¬

---

## ğŸ‰ Káº¿t luáº­n

Quy trÃ¬nh duyá»‡t 2 bÆ°á»›c Ä‘Ã£ Ä‘Æ°á»£c implement hoÃ n chá»‰nh:

- âœ… Leader duyá»‡t â†’ `IN_REVIEW`
- âœ… NgÆ°á»i yÃªu cáº§u xÃ¡c nháº­n â†’ `DONE`
- âœ… Admin cÃ³ thá»ƒ duyá»‡t tháº³ng
- âœ… PhÃ¢n quyá»n chÃ­nh xÃ¡c theo team
- âœ… UI/UX rÃµ rÃ ng vá»›i banner vÃ  nÃºt
- âœ… Notification Ä‘áº§y Ä‘á»§
- âœ… Audit log chi tiáº¿t

**CÃ³ thá»ƒ test ngay!** ğŸŠ

